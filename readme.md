# üöÄ CHEAT SHEET: GESNOVA - Nombres Sem√°nticos ‚Üî F√≠sicos

## üìã Referencia R√°pida Para Developers

---

## üéØ Top 10 Tablas M√°s Usadas

| # | üí° Nombre Sem√°ntico | üîß Tabla F√≠sica | üè∑Ô∏è Alias | ‚≠ê Importancia |
|---|-------------------|----------------|----------|---------------|
| 1 | **DEVENGO_PRESTACION** | `i_accrual` | `iacc`, `ia` | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê CENTRAL |
| 2 | **PACIENTE** | `c_bpartner` | `bp`, `bp_paciente` | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| 3 | **FACTURA** | `c_invoice` | `inv` | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| 4 | **LINEA_FACTURA** | `c_invoiceline` | `il` | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê |
| 5 | **TRANSACCION_CAJA** | `ex_postransaction` | `trx` | ‚≠ê‚≠ê‚≠ê‚≠ê |
| 6 | **CENTRO_MEDICO** | `ex_locale` | `loc` | ‚≠ê‚≠ê‚≠ê‚≠ê |
| 7 | **PRESTACION_MEDICA** | `m_product` | `prod`, `p` | ‚≠ê‚≠ê‚≠ê‚≠ê |
| 8 | **ASEGURADORA** | `c_bpartner` | `bp_aseguradora` | ‚≠ê‚≠ê‚≠ê‚≠ê |
| 9 | **ORGANIZACION** | `ad_org` | `org` | ‚≠ê‚≠ê‚≠ê |
| 10 | **TIPO_DOCUMENTO** | `c_doctype` | `dt` | ‚≠ê‚≠ê‚≠ê |

---

## üîë Columnas Clave por Tabla

### ‚≠ê i_accrual (DEVENGO_PRESTACION)

```sql
-- TABLA CENTRAL DEL SISTEMA
FROM atemplate.i_accrual AS iacc

-- Columnas esenciales:
iacc.datetrx                -- üìÖ Fecha Transaccion
iacc.ex_episodevalue        -- üè• Codigo Episodio
iacc.bpartnervalue          -- üë§ Codigo Paciente
iacc.bpartnername           -- üë§ Nombre Paciente (desnorm)
iacc.productvalue           -- üíä Codigo Prestacion
iacc.description            -- üíä Descripcion Prestacion
iacc.datefrom               -- üìÖ Fecha Prestacion Real
iacc.qtyordered             -- üî¢ Cantidad
iacc.priceactual            -- üí∞ Monto Bruto
iacc.taxamt                 -- üí∞ Monto IVA
iacc.linenetamt             -- üí∞ Monto Neto (TOTAL)
iacc.ex_locale_name         -- üè¢ Centro Medico
iacc.payorvalue             -- üè• Codigo Aseguradora
iacc.payor_name             -- üè• Nombre Aseguradora (desnorm)
iacc.orgvalue               -- üèõÔ∏è Codigo Organizacion
iacc.ex_mainaccount         -- üìä Cuenta Contable
iacc.ex_processtype         -- ‚öôÔ∏è NEW/CANCEL
```

**Joins t√≠picos:**
```sql
-- Paciente
LEFT JOIN c_bpartner AS bp_paciente 
    ON bp_paciente.value = iacc.bpartnervalue

-- Aseguradora
LEFT JOIN c_bpartner AS bp_aseguradora 
    ON bp_aseguradora.value = iacc.payorvalue

-- Prestaci√≥n
LEFT JOIN m_product AS prod 
    ON prod.value = iacc.productvalue
```

---

### üí≥ c_invoice (FACTURA)

```sql
FROM atemplate.c_invoice AS inv

-- Columnas esenciales:
inv.documentno              -- üìÑ Numero Factura
inv.dateinvoiced            -- üìÖ Fecha Venta/Emision
inv.c_bpartner_id           -- üîó FK: ID Paciente
inv.c_doctype_id            -- üîó FK: ID Tipo Documento
inv.c_pos_id                -- üîó FK: ID Punto Venta
inv.ex_episode_value        -- üè• Codigo Episodio
inv.grandtotal              -- üí∞ Monto Total
inv.docstatus               -- ‚öôÔ∏è CO/DR/VO
inv.ispaid                  -- ‚úÖ Pagada? Y/N
```

**Joins t√≠picos:**
```sql
-- L√≠neas de factura
INNER JOIN c_invoiceline AS il 
    ON il.c_invoice_id = inv.c_invoice_id

-- Paciente
INNER JOIN c_bpartner AS bp 
    ON bp.c_bpartner_id = inv.c_bpartner_id

-- Tipo documento
INNER JOIN c_doctype AS dt 
    ON dt.c_doctype_id = inv.c_doctype_id

-- Punto de venta ‚Üí Centro m√©dico
INNER JOIN c_pos AS cpos 
    ON cpos.c_pos_id = inv.c_pos_id
INNER JOIN ex_locale AS loc 
    ON loc.ex_locale_id = cpos.ex_locale_id
```

---

### üìã c_invoiceline (LINEA_FACTURA)

```sql
FROM atemplate.c_invoiceline AS il

-- Columnas esenciales:
il.c_invoice_id             -- üîó FK: ID Factura
il.m_product_id             -- üîó FK: ID Prestacion
il.qtyinvoiced              -- üî¢ Cantidad
il.priceactual              -- üí∞ Precio Unitario
il.linenetamt               -- üí∞ Monto Total Linea
il.ex_insuranceamount       -- üè• Monto Seguro
il.ex_copayment             -- üí≥ Monto Copago
il.ex_surplusamount         -- üí∏ Monto Excedente

-- VALIDACI√ìN CR√çTICA:
-- linenetamt = ex_insuranceamount + ex_copayment + ex_surplusamount
```

---

### üßæ ex_postransaction (TRANSACCION_CAJA)

```sql
FROM atemplate.ex_postransaction AS trx

-- Columnas esenciales:
trx.value                   -- üßæ Numero Transaccion POS
trx.created                 -- üìÖ Fecha Hora Transaccion
trx.created::date           -- üìÖ Fecha Proceso (solo fecha)
trx.ex_possession_id        -- üîó FK: ID Caja
trx.c_bpartner_id           -- üîó FK: ID Paciente
trx.docstatus               -- ‚öôÔ∏è CO/DR

-- Extraer hora:
to_char(trx.created, 'HH24:MI:SS') AS hora_proceso
```

**Joins t√≠picos:**
```sql
-- L√≠neas de transacci√≥n
INNER JOIN ex_postransactionline AS trxline 
    ON trxline.ex_postransaction_id = trx.ex_postransaction_id

-- Caja
INNER JOIN ex_possession AS pos 
    ON pos.ex_possession_id = trx.ex_possession_id

-- Cajero (desde caja)
INNER JOIN ad_user AS usr 
    ON usr.ad_user_id = pos.createdby

-- Centro m√©dico (cadena)
INNER JOIN c_pos AS cpos 
    ON cpos.c_pos_id = pos.c_pos_id
INNER JOIN ex_locale AS loc 
    ON loc.ex_locale_id = cpos.ex_locale_id
```

---

### üë§ c_bpartner (PACIENTE / ASEGURADORA)

```sql
FROM atemplate.c_bpartner AS bp

-- Columnas esenciales COMUNES:
bp.c_bpartner_id            -- üîë ID Unico
bp.value                    -- üìã Codigo
bp.taxid                    -- üÜî RUT
bp.name                     -- üë§ Nombre
bp.phone                    -- üìû Telefono
bp.email                    -- üìß Email

-- Solo PACIENTE:
bp.iscustomer               -- ‚úÖ 'Y' para pacientes
bp.birthday                 -- üìÖ Fecha Nacimiento
bp.gender                   -- ‚öß M/F
bp.bloodgroup               -- ü©∏ Grupo Sanguineo
bp.ex_payor_id              -- üîó FK: ID Aseguradora

-- Distinguir:
WHERE bp.iscustomer = 'Y'   -- PACIENTE
-- o buscar en payorvalue    -- ASEGURADORA
```

---

## üîó Patrones de Join

### üìå Patr√≥n 1: Join por VALUE (c√≥digo alfanum√©rico)
```sql
-- Com√∫n en i_accrual
i_accrual.bpartnervalue = c_bpartner.value
i_accrual.payorvalue = c_bpartner.value
i_accrual.productvalue = m_product.value
```
**‚ö†Ô∏è NO es join por ID, sino por c√≥digo**

### üìå Patr√≥n 2: Join por ID (FK tradicional)
```sql
-- Com√∫n en facturas
c_invoiceline.c_invoice_id = c_invoice.c_invoice_id
c_invoice.c_bpartner_id = c_bpartner.c_bpartner_id
c_invoiceline.m_product_id = m_product.m_product_id
```

### üìå Patr√≥n 3: Join en Cadena (Navegaci√≥n)
```sql
-- De Transacci√≥n a Centro M√©dico:
ex_postransaction
    ‚Üí ex_possession (caja)
    ‚Üí c_pos (punto de venta)
    ‚Üí ex_locale (centro m√©dico)
```

### üìå Patr√≥n 4: COALESCE para Alternativas
```sql
-- Medio de pago de dos fuentes posibles:
COALESCE(ex_tendertype.name, c_doctype.printname) AS medio_pago
```

---

## üéØ Queries de Ejemplo R√°pido

### Ejemplo 1: Devengos de un Paciente
```sql
SELECT 
    iacc.ex_episodevalue AS codigo_episodio,
    iacc.description AS prestacion,
    iacc.datefrom AS fecha,
    iacc.linenetamt AS monto
FROM atemplate.i_accrual iacc
LEFT JOIN atemplate.c_bpartner bp ON bp.value = iacc.bpartnervalue
WHERE bp.taxid = '12345678-9'
ORDER BY iacc.datefrom DESC;
```

### Ejemplo 2: Facturas del D√≠a
```sql
SELECT 
    inv.documentno AS factura,
    bp.name AS paciente,
    inv.grandtotal AS total
FROM atemplate.c_invoice inv
INNER JOIN atemplate.c_bpartner bp ON bp.c_bpartner_id = inv.c_bpartner_id
WHERE inv.dateinvoiced = CURRENT_DATE
    AND inv.docstatus = 'CO';
```

### Ejemplo 3: Cierre de Caja
```sql
SELECT 
    pos.name AS caja,
    usr.name AS cajero,
    COUNT(*) AS transacciones,
    SUM(trxline.linenetamt) AS total
FROM atemplate.ex_postransaction trx
INNER JOIN atemplate.ex_postransactionline trxline 
    ON trxline.ex_postransaction_id = trx.ex_postransaction_id
INNER JOIN atemplate.ex_possession pos 
    ON pos.ex_possession_id = trx.ex_possession_id
INNER JOIN atemplate.ad_user usr 
    ON usr.ad_user_id = pos.createdby
WHERE DATE(trx.created) = CURRENT_DATE
    AND trx.docstatus = 'CO'
GROUP BY pos.name, usr.name;
```

---

## üìä Estados y Valores Comunes

### docstatus (Estado de Documento)
```
'DR' = Draft        (Borrador)
'CO' = Completed    (Completado) ‚úÖ
'VO' = Voided       (Anulado) ‚ùå
'CL' = Closed       (Cerrado)
```

### ex_processtype (Tipo de Proceso en Devengo)
```
'NEW'     = Cargo nuevo ‚úÖ
'CANCEL'  = Anulaci√≥n ‚ùå
```

### printname (Tipos de Documento)
```
'Boleta'
'Boleta Manual'
'Exempt Ticket'         (Boleta Exenta)
'Invoice'               (Factura)
'Factura Exenta'
'Credit Memo'           (Nota de Cr√©dito)
'Nota de Credito (test)'
```

---

## üí∞ F√≥rmulas Financieras Cr√≠ticas

### En c_invoiceline
```sql
-- SIEMPRE debe cumplirse:
linenetamt = ex_insuranceamount + ex_copayment + ex_surplusamount

-- Validaci√≥n:
SELECT 
    c_invoiceline_id,
    linenetamt AS total,
    (ex_insuranceamount + ex_copayment + ex_surplusamount) AS suma,
    (linenetamt - (ex_insuranceamount + ex_copayment + ex_surplusamount)) AS diferencia
FROM c_invoiceline
WHERE ABS(linenetamt - (ex_insuranceamount + ex_copayment + ex_surplusamount)) > 0.01;
```

### En i_accrual
```sql
-- Monto Neto = Monto Bruto + IVA
linenetamt = priceactual + taxamt
```

---

## üè∑Ô∏è Convenciones de Nomenclatura

### Prefijos de Campos
- `ex_*` = Extensiones GESNOVA (customizaciones)
- `c_*` = Core/Cliente (entidades principales)
- `m_*` = Maestros (cat√°logos)
- `ad_*` = Application Dictionary (admin)
- `i_*` = Information (vistas de negocio)

### Sufijos Comunes
- `*_id` = Clave primaria o for√°nea
- `*value` = C√≥digo alfanum√©rico
- `*name` = Nombre descriptivo
- `*amt` = Monto/Amount
- `*qty` = Cantidad/Quantity

---

## üîç Campos Desnormalizados en i_accrual

‚ö†Ô∏è **IMPORTANTE:** Estos campos est√°n duplicados para performance:

```sql
i_accrual.bpartnername      ‚Üê c_bpartner.name
i_accrual.payor_name        ‚Üê c_bpartner.name (aseguradora)
i_accrual.ex_locale_name    ‚Üê ex_locale.name
i_accrual.description       ‚Üê m_product.name
```

**Ventaja:** Queries m√°s r√°pidas  
**Desventaja:** Deben mantenerse sincronizados

---

## üìÖ Filtros de Fecha Comunes

```sql
-- Rango de fechas (patr√≥n recomendado)
WHERE datetrx >= TIMESTAMP '2025-10-01 00:00:00'
  AND datetrx <  TIMESTAMP '2025-11-01 00:00:00'

-- Solo fecha (sin timestamp)
WHERE dateinvoiced >= DATE '2025-10-01'
  AND dateinvoiced <  DATE '2025-11-01'

-- D√≠a actual
WHERE DATE(created) = CURRENT_DATE

-- Mes actual
WHERE DATE_TRUNC('month', datetrx) = DATE_TRUNC('month', CURRENT_DATE)
```

---

## üß© Diagrama de Relaciones Simplificado

```
ORGANIZACION (ad_org)
    ‚Üì
    ‚îú‚îÄ‚Üí PACIENTE (c_bpartner where iscustomer='Y')
    ‚îú‚îÄ‚Üí CENTRO_MEDICO (ex_locale)
    ‚îî‚îÄ‚Üí PUNTO_VENTA (c_pos) ‚Üí CAJA (ex_possession)

PACIENTE
    ‚îú‚îÄ‚Üí EPISODIO (ex_episodevalue en i_accrual)
    ‚îÇ       ‚Üì
    ‚îÇ   DEVENGO (i_accrual) ‚Üê PRESTACION (m_product)
    ‚îÇ       ‚Üì                 ‚Üë
    ‚îÇ   FACTURA (c_invoice)   ‚îÇ
    ‚îÇ       ‚Üì                 ‚îÇ
    ‚îÇ   LINEA_FACTURA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ       (c_invoiceline)
    ‚îî‚îÄ‚Üí TRANSACCION_CAJA (ex_postransaction)
            ‚Üì
        LINEA_TRANSACCION (ex_postransactionline)
```

---

## üéì Tips Pro

### 1. Siempre validar estado
```sql
WHERE docstatus = 'CO'  -- Solo documentos completados
```

### 2. Usar COALESCE para nulls
```sql
COALESCE(tend.name, dt.printname, 'Sin especificar') AS medio_pago
```

### 3. Formatear montos
```sql
TO_CHAR(linenetamt, 'FM999,999,999') AS monto_formateado
```

### 4. Agrupar por periodo
```sql
DATE_TRUNC('month', datetrx)::DATE AS periodo_mes
```

### 5. Verificar tipos de documento
```sql
WHERE dt.printname IN ('Boleta', 'Invoice', 'Factura Exenta')
```

---

## üö® Errores Comunes

### ‚ùå ERROR 1: Join incorrecto en i_accrual
```sql
-- MAL:
JOIN c_bpartner ON c_bpartner.c_bpartner_id = i_accrual.????

-- BIEN:
JOIN c_bpartner ON c_bpartner.value = i_accrual.bpartnervalue
```

### ‚ùå ERROR 2: Olvidar filtrar estado
```sql
-- MAL: incluye borradores y anulados
SELECT * FROM c_invoice

-- BIEN:
SELECT * FROM c_invoice WHERE docstatus = 'CO'
```

### ‚ùå ERROR 3: No validar suma de montos
```sql
-- MAL: asumir que la suma est√° bien
SELECT linenetamt FROM c_invoiceline

-- BIEN: validar
SELECT 
    linenetamt,
    (ex_insuranceamount + ex_copayment + ex_surplusamount) AS verificacion
FROM c_invoiceline
WHERE ABS(linenetamt - (ex_insuranceamount + ex_copayment + ex_surplusamount)) > 0.01
```

---

## üìö Referencias R√°pidas

| Necesito... | Ver documento... |
|------------|------------------|
| Queries reales completas | `documentacion_hibrida_completa.md` |
| Modelo visual | `modelo_conceptual_hibrido_gesnova.mermaid` |
| Alias SQL | `alias_semanticos_gesnova.sql` |
| Gu√≠a de uso | `guia_rapida_alias_semanticos.md` |

---

## üéØ Casos de Uso Ultra-R√°pidos

### "Necesito devengos de un episodio"
```sql
SELECT * FROM atemplate.i_accrual 
WHERE ex_episodevalue = 'EP-2025-001';
```

### "Necesito facturas de un paciente"
```sql
SELECT inv.* FROM atemplate.c_invoice inv
JOIN atemplate.c_bpartner bp ON bp.c_bpartner_id = inv.c_bpartner_id
WHERE bp.taxid = '12345678-9';
```

### "Necesito ventas del d√≠a"
```sql
SELECT documentno, grandtotal FROM atemplate.c_invoice
WHERE dateinvoiced = CURRENT_DATE AND docstatus = 'CO';
```

### "Necesito cierre de caja"
```sql
SELECT SUM(linenetamt) FROM atemplate.ex_postransactionline trxline
JOIN atemplate.ex_postransaction trx ON trx.ex_postransaction_id = trxline.ex_postransaction_id
WHERE DATE(trx.created) = CURRENT_DATE AND trx.docstatus = 'CO';
```

---

**FIN DEL CHEAT SHEET**

*Imprime esto y p√©galo en tu escritorio* üìå
